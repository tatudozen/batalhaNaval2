version: '3.8'

services:
  batalha-naval:
    # Opção 1: Build local no Portainer
    # build: .

    # Opção 2: Usar imagem do GitHub (descomente se preferir)
    image: ghcr.io/tatudozen/batalha-naval:latest

    # container_name: batalha-naval # Not supported in Swarm
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

    environment:
      - NODE_ENV=production
      - PORT=3001
      - BASE_URL=https://batnav.alquimiazen.com.br

    volumes:
      # Persistência do banco de dados
      - batnav-data:/app/data
      # Sessão do WhatsApp (persistir entre restarts)
      - batnav-whatsapp:/app/backend/.wwebjs_auth
      # Logs
      - batnav-logs:/app/backend/logs

    networks:
      - AZ_Net

    labels:
      # Habilitar Traefik
      - "traefik.enable=true"

      # Rede do Traefik
      - "traefik.docker.network=AZ_Net"

      # Router HTTPS
      - "traefik.http.routers.batalha-naval.rule=Host(`batnav.alquimiazen.com.br`)"
      - "traefik.http.routers.batalha-naval.entrypoints=websecure"
      - "traefik.http.routers.batalha-naval.tls=true"
      - "traefik.http.routers.batalha-naval.tls.certresolver=letsencryptresolver"

      # Service
      - "traefik.http.services.batalha-naval.loadbalancer.server.port=3001"

    healthcheck:
      test: [ "CMD", "node", "-e", "require('http').get('http://localhost:3001/api/matches', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

volumes:
  batnav-data:
  batnav-whatsapp:
  batnav-logs:


networks:
  AZ_Net:
    external: true
